# 📍 데드락 (DeadLock)

- 교착상태
- 시스템 자원에 대한 요구가 뒤엉킨 상태로, 둘 이상의 프로세스가 다른 프로세스가 점유하고 있는 자원을 서로 기다릴 때 `무한 대기`에 빠지는 상황

<br>

💡 프로세스가 자원을 사용하는 절차
- Request : 자원을 요청하고, 만약 다른 프로세스가 자원을 사용하고 있어 받을 수 없다면 대기한다.
- Allocate : 자원을 받는다.
- Use : 받은 자원을 사용한다.
- Release : 자원을 놓아준다.

=> 데드락은 모든 프로세스가 `Request` 상태인 상황

<br>

## 데드락 발생 조건

![image](https://user-images.githubusercontent.com/78673570/194749210-5f212147-95ce-49f1-a044-ccd75d6a254d.png)
(ex. 왼쪽 : 데드락 O, 오른쪽 : 데드락 X)

데드락이 발생하기 위해서는 다음 4가지 조건을 만족해야 한다.

<br>

1. `Mutual exclusion (상호 배제)` : 한 번에 하나의 프로세스만이 자원을 사용할 수 있다.
2. `Hold and wait (보유 대기)` : 자원을 최소한 하나 보유하고, 다른 프로세스에 할당된 자원을 점유하기 위해 대기하는 프로세스가 존재해야 한다.
3. `No preemption (비선점)` : 이미 할당된 자원을 강제로 빼앗을 수 없다.
4. `Circular wait (순환 대기)` : 자원을 기다리는 프로세스 간에 사이클이 형성되어야 한다. (사이클이 없다면 데드락이 아니고, 사이클이 있다면 데드락이 발생할 '가능성'이 있다 !)

<br>

## 데드락 해결 방법

### 예방 (Prevention)

- 데드락 발생 조건 4가지 중, 하나라도 발생하지 않게 하는 것
- 예방 방식은 자원 낭비가 심하여, 효율성과 처리량을 감소시키는 문제가 발생할 수 있다.

<br>

1. `Mutual exclusion (상호 배제)` 예방
    - 한 번에 여러 프로세스가 공유 자원을 사용할 수 있도록 해야 한다.
    - 그러나 동기화 관련 문제가 발생할 수 있다.
2. `Hold and wait (보유 대기)` 예방
    - 프로세스가 자원을 요청할 때 다른 어떤 자원도 가지고 있지 않도록 해야 한다.
    - 따라서 프로세스를 시작할 때 실행에 필요한 모든 조건을 한꺼번에 요구하거나, 자원이 필요한 경우 보유하고 있던 자원을 모두 반납하고 다시 요청하는 방식을 이용할 수 있다.
3. `No preemption (비선점)` 예방
    - 이미 다른 프로세스에게 할당된 자원이 선점권이 없다고 가정할 때, 높은 우선순위의 프로세스가 해당 자원을 선점할 수 있도록 한다.
4. `Circular wait (순환 대기)` 예방
    - 자원을 순환 형태로 대기하지 않도록 일정한 한 쪽 방향으로만 할당 순서를 정하여, 정해진 순서대로만 자원을 요구할 수 있도록 한다.

<br>

### 회피 (Avoidance)

- 데드락이 발생할 가능성이 있는 경우에는 아예 자원을 할당하지 않는 방식
- 시스템이 `불안정 상태(unsafe state)`에 들어가지 않는 것을 보장
- 프로세스들이 요청하는 모든 자원을, 데드락을 발생시키지 않으면서도 차례로 모두에게 할당해 줄 수 있다면 `안정 상태(safe state)`에 있다고 하고, 이처럼 특정한 순서로 프로세스들에게 자원을 할당/실행/종료 등의 작업을 할 때 데드락이 발생하지 않는 순서를 찾을 수 있다면, 그것을 `안전 순서(safe sequence)`라고 한다.

<br>

💡 은행원 알고리즘(Banker’s Algorithm)

- 다익스트라가 고안한 알고리즘으로, 프로세스가 자원을 요청할 때마다 수행된다.
- 어떤 자원의 할당을 허용하는지에 관한 여부를 결정하기 전에, 미리 결정된 모든 자원들의 최대 가능한 할당량을 가지고 시뮬레이션 해서 Safe state에 들 수 있는지 여부를 검사한다. 즉, 대기 중인 다른 프로세스들의 활동에 대한 데드락 가능성을 미리 조사하는 것
- 안정 상태이면 자원을 할당하고 아니면 다른 프로세스들이 자원을 해제할 때까지 대기한다.
- 미리 최대 자원 요구량을 알아야 하고, 할당할 수 있는 자원 수가 일정해야 하는 등 사용에 있어 제약조건이 많고 그에 따른 자원 이용도가 하락한다는 단점이 있다.

<br>

### 탐지(Detection) 및 회복(Recovery)
회복하기 위해 데드락을 탐지하고, 회복하는 알고리즘을 사용하는 것

<br>

1. `탐지 기법`
    1. 자원 할당 상태 : 은행원 알고리즘에서의 방식과 유사하게 Allocation, Request, Available 등을 통해 시스템에 데드락이 발생했는지 여부를 탐지
    2. 자원 할당 그래프 : 자원 할당 그래프를 통해 탐지
2. `회복 기법` : 탐지 기법을 통해 데드락을 발견했다면, 회복하기 위한 방법을 사용
    1. 프로세스를 1개 이상 중단 시키기
        - 데드락에 빠진 모든 프로세스를 중단 : 연산 중이던 프로세스들도 중단되어 결과에 문제가 생길 수 있다는 부작용이 발생할 수 있다.
        - 프로세스를 하나씩 중단시킬 때마다 탐지 알고리즘으로 데드락을 탐지하면서 회복시키기 : 매번 탐지 알고리즘을 호출해야하므로 부담이될 수 있다.
    2. 자원 선점하기
        - 프로세스에 할당된 자원을 선점하여, 데드락을 해결할 때까지 그 자원을 다른 프로세스에게 할당해주는 방법
